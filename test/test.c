#include "../src/json_value.h"
#include "../src/json_string.h"
#include "../src/json_stringifier.h"
#include "../src/json_array.h"

#include <stdio.h>
#include <float.h>
#include <stdlib.h>
#include <assert.h>

static void should_change_object_properties() {
    json_value* item = json_value_alloc();
    item->type = JSONValueObject;
    item->json_object = json_object_alloc();
    json_value* undefined = json_undefined_alloc();
    json_object_set_property(item->json_object, "Test property", undefined);

    assert(json_object_get_property(item->json_object, "Test property") == undefined);
    assert(json_object_get_property(item->json_object, "") == NULL);
    assert(json_object_get_property(item->json_object, " ") == NULL);

    json_value_free(item);
}

static void should_stringify_numbers() {
    uint32_t i, n = 16;
    json_value* value = json_value_alloc();
    value->type = JSONValueArray;
    value->json_array = json_array_alloc();
    json_value* item;

    for(i = 0; i < n; i++) {
        item = json_string_alloc("Value");
        json_values_list_add(value->json_array->items, item);

        item = json_value_alloc();
        item->type = JSONValueNumber;
        item->json_number = 4294967295.000000;
        json_values_list_add(value->json_array->items, item);

        item = json_value_alloc();
        item->type = JSONValueNumber;
        item->json_number = 179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.0000;
        json_values_list_add(value->json_array->items, item);

        item = json_value_alloc();
        item->type = JSONValueNumber;
        item->json_number = -2147483647.000000;
        json_values_list_add(value->json_array->items, item);
    }

    json_stringifier* stringifier = json_stringifier_alloc();
    json_stringifier_stringify(stringifier, value);

    const char* expected = "[\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000,\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000,\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000,\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000,\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000,\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000,\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000,\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000,\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000,\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000,\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000,\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000,\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000,\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000,\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000,\"Value\",4294967295.000000,179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368.000000,-2147483647.000000]";
    assert(json_characters_list_length(stringifier->characters_list) == 5793);
    vector_foreach(stringifier->characters_list, j) {
        char ch = vector_get(stringifier->characters_list, j);
        assert(expected[j] == ch);
    }

    json_value_free(value);
    json_stringifier_free(stringifier);
}

static void should_stringify_objects() {
    json_value* n1 = json_value_alloc();
    n1->type = JSONValueNumber;
    n1->json_number = 1024;

    json_value* obj2 = json_value_alloc();
    obj2->type = JSONValueObject;
    obj2->json_object = json_object_alloc();
    json_object_set_property(obj2->json_object, "b", n1);

    json_value* string1 = json_string_alloc("Hi. How\"re you doing?");
    json_object_set_property(obj2->json_object, "c", string1);

    json_value* obj = json_value_alloc();
    obj->type = JSONValueObject;
    obj->json_object = json_object_alloc();

    json_object_set_property(obj->json_object, "a", obj2);

    json_stringifier* stringifier = json_stringifier_alloc();
    json_stringifier_stringify(stringifier, obj);

    assert(strcmp(json_stringifier_to_string(stringifier), "{\"a\":{\"b\":1024.000000,\"c\":\"Hi. How\\\"re you doing?\"}}")==0);

    json_stringifier_free(stringifier);
    json_value_free(obj);
}

int main() {
    should_change_object_properties();
    should_stringify_numbers();
    should_stringify_objects();
    return 0;
}
